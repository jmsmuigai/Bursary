<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Run End-to-End Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }
    .test-container {
      max-width: 800px;
      margin: 0 auto;
    }
    .test-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      padding: 2rem;
    }
    .status-badge {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: bold;
      margin: 0.5rem 0;
    }
    .status-pending { background: #ffc107; color: #000; }
    .status-success { background: #28a745; color: #fff; }
    .status-error { background: #dc3545; color: #fff; }
  </style>
</head>
<body>
  <div class="test-container">
    <div class="test-card">
      <h1 class="text-center mb-4">
        <i class="bi bi-play-circle-fill text-primary"></i>
        End-to-End System Test
      </h1>
      
      <div class="alert alert-info">
        <h5><i class="bi bi-info-circle me-2"></i>What This Test Does:</h5>
        <ol class="mb-0">
          <li>Creates a test applicant (Registration)</li>
          <li>Creates a test application with all required fields</li>
          <li>Awards the application (Ksh 100,000)</li>
          <li>Generates and auto-downloads the award letter PDF</li>
        </ol>
      </div>
      
      <div id="testStatus" class="mb-4">
        <h5>Test Status:</h5>
        <div id="statusMessages"></div>
      </div>
      
      <div class="d-grid gap-2">
        <button class="btn btn-primary btn-lg" onclick="runTest()" id="runTestBtn">
          <i class="bi bi-play-fill me-2"></i>Run Complete Test
        </button>
        <button class="btn btn-secondary" onclick="checkSystem()">
          <i class="bi bi-check-circle me-2"></i>Check System Status
        </button>
        <button class="btn btn-warning" onclick="clearTestData()">
          <i class="bi bi-trash me-2"></i>Clear Test Data
        </button>
      </div>
      
      <div id="testResults" class="mt-4" style="display:none;">
        <h5>Test Results:</h5>
        <div id="resultsContent"></div>
      </div>
    </div>
  </div>

  <!-- Load required scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/data.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase_config.js"></script>
  <script src="js/firebase-db.js"></script>
  <script src="js/database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="js/pdf-generator.js"></script>
  <script src="js/end-to-end-test.js"></script>

  <script>
    function addStatusMessage(message, type = 'info') {
      const statusMessages = document.getElementById('statusMessages');
      const badge = document.createElement('div');
      badge.className = `status-badge status-${type}`;
      badge.innerHTML = `<i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info-circle'} me-2"></i>${message}`;
      statusMessages.appendChild(badge);
      statusMessages.scrollTop = statusMessages.scrollHeight;
    }

    function clearStatus() {
      document.getElementById('statusMessages').innerHTML = '';
      document.getElementById('testResults').style.display = 'none';
    }

    async function runTest() {
      const btn = document.getElementById('runTestBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Running Test...';
      
      clearStatus();
      addStatusMessage('Starting complete workflow test...', 'pending');
      
      try {
        // Wait a bit for scripts to load
        await new Promise(resolve => setTimeout(resolve, 500));
        
        if (typeof simulateCompleteWorkflow === 'function') {
          addStatusMessage('Test function found, executing...', 'info');
          
          const result = await simulateCompleteWorkflow();
          
          if (result.success) {
            addStatusMessage('✅ All tests passed!', 'success');
            addStatusMessage(`Application ID: ${result.applicationId}`, 'success');
            addStatusMessage(`Amount Awarded: Ksh ${result.awardAmount.toLocaleString()}`, 'success');
            addStatusMessage(`Serial Number: ${result.serialNumber}`, 'success');
            addStatusMessage('PDF should be in your downloads folder!', 'success');
            
            // Show detailed results
            showResults(result);
          } else {
            addStatusMessage('⚠️ Some tests failed', 'error');
            if (result.error) {
              addStatusMessage(`Error: ${result.error}`, 'error');
            }
            showResults(result);
          }
        } else {
          throw new Error('Test function not found. Please ensure end-to-end-test.js is loaded.');
        }
      } catch (error) {
        addStatusMessage(`❌ Test Error: ${error.message}`, 'error');
        console.error('Test error:', error);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-play-fill me-2"></i>Run Complete Test';
      }
    }

    function showResults(result) {
      const resultsDiv = document.getElementById('testResults');
      const contentDiv = document.getElementById('resultsContent');
      
      let html = '<div class="card"><div class="card-body">';
      html += '<h6>Detailed Results:</h6>';
      
      if (result.results) {
        Object.keys(result.results).forEach(key => {
          const r = result.results[key];
          const icon = r.success ? '✅' : '❌';
          const color = r.success ? 'text-success' : 'text-danger';
          html += `<p class="${color}">${icon} ${key}: ${r.success ? 'PASS' : 'FAIL'}`;
          if (r.error) html += ` - ${r.error}`;
          html += '</p>';
        });
      }
      
      html += '</div></div>';
      contentDiv.innerHTML = html;
      resultsDiv.style.display = 'block';
    }

    function checkSystem() {
      clearStatus();
      addStatusMessage('Checking system status...', 'info');
      
      const checks = {
        'PDF Generator': typeof generateOfferLetterPDF === 'function',
        'Database Functions': typeof saveApplication !== 'undefined' || localStorage.getItem('mbms_applications') !== null,
        'Test Function': typeof simulateCompleteWorkflow === 'function',
        'jsPDF Library': typeof window.jspdf !== 'undefined' || typeof window.jsPDF !== 'undefined'
      };
      
      Object.keys(checks).forEach(key => {
        const status = checks[key] ? 'success' : 'error';
        const icon = checks[key] ? '✅' : '❌';
        addStatusMessage(`${icon} ${key}: ${checks[key] ? 'Available' : 'Not Available'}`, status);
      });
    }

    function clearTestData() {
      if (confirm('⚠️ This will remove all test data (test applicant and application).\n\nContinue?')) {
        try {
          // Remove test applicant
          const users = JSON.parse(localStorage.getItem('mbms_users') || '[]');
          const filtered = users.filter(u => u.email !== 'test.applicant@garissa.test');
          localStorage.setItem('mbms_users', JSON.stringify(filtered));
          
          // Remove test application
          const apps = JSON.parse(localStorage.getItem('mbms_applications') || '[]');
          const filteredApps = apps.filter(a => a.applicantEmail !== 'test.applicant@garissa.test');
          localStorage.setItem('mbms_applications', JSON.stringify(filteredApps));
          
          clearStatus();
          addStatusMessage('✅ Test data cleared successfully!', 'success');
        } catch (error) {
          addStatusMessage(`❌ Error clearing data: ${error.message}`, 'error');
        }
      }
    }

    // Auto-check system on load
    window.addEventListener('load', function() {
      setTimeout(checkSystem, 1000);
    });
  </script>
</body>
</html>

