<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Register for Garissa County Bursary Application" />
  <title>Garissa MBMS • Register</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-app">
  <div class="container py-4 py-md-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card border-0 shadow-lg rounded-4">
          <div class="card-body p-4 p-md-5">
            <div class="text-center mb-4">
              <img src="Garissa Logo.png" alt="" class="logo-circle mb-2" onerror="this.style.display='none'"/>
              <h3 class="text-primary-700 fw-bold mb-1">Applicant Account Registration</h3>
              <div class="text-muted small">Create an account to apply for the county bursary</div>
            </div>

            <div class="alert alert-warning border-0 mb-4">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Note:</strong> If you don't have a National ID, you can use your Birth Certificate Entry Number instead.
            </div>

            <form id="applicantRegistrationForm" class="row g-3 needs-validation" novalidate>
              <h5 class="col-12 mt-2 text-primary-700"><i class="bi bi-person me-2"></i>Personal & Contact Information</h5>
              
              <div class="col-md-4">
                <label class="form-label">Surname <span class="text-danger">*</span></label>
                <input id="lastName" class="form-control" placeholder="e.g. Mukoma" required />
                <div class="invalid-feedback">Surname is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">First Name <span class="text-danger">*</span></label>
                <input id="firstName" class="form-control" placeholder="e.g. James" required />
                <div class="invalid-feedback">First name is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Other Name(s)</label>
                <input id="otherName" class="form-control" placeholder="e.g. Muigai" />
              </div>

              <div class="col-md-6">
                <label class="form-label">Email Address <span class="text-danger">*</span></label>
                <input id="emailAddress" type="email" class="form-control" placeholder="e.g. jmsmuigai@gmail.com" required />
                <div class="invalid-feedback">Valid email is required.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                <input id="phoneNumber" type="tel" class="form-control" placeholder="e.g. 0712345678" required />
                <div class="invalid-feedback">Phone number is required.</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Gender <span class="text-danger">*</span></label>
                <select id="gender" class="form-select" required>
                  <option value="">-- Select Gender --</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
                <div class="invalid-feedback">Gender is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                <input id="dateOfBirth" type="date" class="form-control" required />
                <div class="invalid-feedback">Date of birth is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Year of Birth <span class="text-danger">*</span></label>
                <input id="yearOfBirth" type="number" class="form-control" min="1980" max="2010" placeholder="e.g. 2000" required />
                <div class="invalid-feedback">Year of birth is required.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Identification Type <span class="text-danger">*</span></label>
                <select id="idType" class="form-select" required>
                  <option value="">-- Select Type --</option>
                  <option value="National ID">National ID Number</option>
                  <option value="Birth Certificate">Birth Certificate Entry Number</option>
                </select>
                <div class="invalid-feedback">Identification type is required.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label" id="idLabel">National ID Number <span class="text-danger">*</span></label>
                <input id="nemisId" class="form-control" placeholder="e.g. 12345678" required />
                <div class="invalid-feedback">ID number is required.</div>
              </div>

              <h5 class="col-12 mt-3 text-primary-700"><i class="bi bi-geo-alt me-2"></i>Home Location (Garissa County)</h5>
              
              <div class="col-md-6">
                <label class="form-label">Home Sub-County <span class="text-danger">*</span></label>
                <select id="subCounty" class="form-select" required></select>
                <div class="invalid-feedback">Sub-county is required.</div>
              </div>
              <div class="col-md-6" id="otherSubCountyDiv" style="display:none;">
                <label class="form-label">Specify Sub-County <span class="text-danger">*</span></label>
                <input id="otherSubCounty" class="form-control" placeholder="Enter missing Sub-County" />
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Home Ward <span class="text-danger">*</span></label>
                <select id="ward" class="form-select" required disabled>
                  <option value="">-- Select Ward --</option>
                </select>
                <div class="invalid-feedback">Ward is required.</div>
              </div>
              <div class="col-md-6" id="otherWardDiv" style="display:none;">
                <label class="form-label">Specify Ward <span class="text-danger">*</span></label>
                <input id="otherWard" class="form-control" placeholder="Enter missing Ward" />
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Village/Bulla/Estate</label>
                <input id="village" class="form-control" placeholder="e.g. Bulla Iftin" />
              </div>

              <h5 class="col-12 mt-3 text-primary-700"><i class="bi bi-shield-lock me-2"></i>Security Credentials</h5>
              
              <div class="col-md-6">
                <label class="form-label">Password <span class="text-danger">*</span></label>
                <input id="password" type="password" class="form-control" minlength="8" required />
                <div class="form-text">Minimum 8 characters, include numbers and symbols</div>
                <div class="invalid-feedback">Password must be at least 8 characters.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Confirm Password <span class="text-danger">*</span></label>
                <input id="confirmPassword" type="password" class="form-control" required />
                <div class="invalid-feedback" id="passwordMatchFeedback">Passwords do not match.</div>
              </div>
              
              <div class="col-12 mt-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="robotCheck" required />
                  <label class="form-check-label" for="robotCheck">I'm not a robot (CAPTCHA)</label>
                  <div class="invalid-feedback">Please confirm you're not a robot.</div>
                </div>
              </div>
              
              <div class="col-12 mt-3">
                <button class="btn btn-primary-700 w-100 py-2" type="submit">
                  <i class="bi bi-person-plus me-2"></i>Register Account
                </button>
              </div>
              
              <div class="col-12 text-center">
                <a href="index.html" class="link-primary-700 text-decoration-none small">Already have an account? Login →</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/data.js"></script>
  <script src="js/auth.js"></script>
  
  <!-- Footer -->
  <footer class="mt-5 py-4" style="background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%); color: white;">
    <div class="container">
      <div class="text-center">
        <p class="mb-2" style="font-size: 0.9rem;">
          <span style="color: #FFD700; font-weight: bold;">Garissa County Bursary Management System v2.0</span>
        </p>
        <p class="mb-0" style="font-size: 0.85rem; opacity: 0.9;">
          System developed by <a href="mailto:jmsmuigai@gmail.com" style="color: #FFD700; text-decoration: none; font-weight: bold;">jmsmuigai@gmail.com</a>
        </p>
        <p class="mt-2 mb-0" style="font-size: 0.75rem; opacity: 0.8;">
          © 2025 Garissa County Government. All rights reserved.
        </p>
      </div>
    </div>
  </footer>
  <script>
    const subCountySelect = document.getElementById('subCounty');
    const wardSelect = document.getElementById('ward');
    const otherSubCountyDiv = document.getElementById('otherSubCountyDiv');
    const otherWardDiv = document.getElementById('otherWardDiv');
    const otherSubCountyInput = document.getElementById('otherSubCounty');
    const otherWardInput = document.getElementById('otherWard');
    const idTypeSelect = document.getElementById('idType');
    const idLabel = document.getElementById('idLabel');
    const nemisIdInput = document.getElementById('nemisId');
    const dateOfBirthInput = document.getElementById('dateOfBirth');
    const yearOfBirthInput = document.getElementById('yearOfBirth');

    // Update ID label based on selection
    idTypeSelect.addEventListener('change', function() {
      if (this.value === 'Birth Certificate') {
        idLabel.textContent = 'Birth Certificate Entry Number *';
        nemisIdInput.placeholder = 'e.g. 0121514529';
      } else {
        idLabel.textContent = 'National ID Number *';
        nemisIdInput.placeholder = 'e.g. 12345678';
      }
    });

    // Sync date of birth with year of birth
    dateOfBirthInput.addEventListener('change', function() {
      if (this.value) {
        const year = new Date(this.value).getFullYear();
        yearOfBirthInput.value = year;
      }
    });

    yearOfBirthInput.addEventListener('change', function() {
      if (this.value) {
        const date = new Date(this.value, 0, 1);
        dateOfBirthInput.value = date.toISOString().split('T')[0];
      }
    });

    // Populate subcounties
    subCountySelect.innerHTML = '<option value="">-- Select Sub-County --</option>';
    Object.keys(GARISSA_WARDS).forEach(sc => {
      const opt = new Option(sc, sc);
      subCountySelect.add(opt);
    });
    subCountySelect.add(new Option('Other (Specify below)', 'other_subcounty'));

    function populateWards() {
      wardSelect.innerHTML = '<option value="">-- Select Ward --</option>';
      wardSelect.disabled = true;
      otherSubCountyDiv.style.display = 'none';
      otherWardDiv.style.display = 'none';
      otherSubCountyInput.removeAttribute('required');
      otherWardInput.removeAttribute('required');

      const sc = subCountySelect.value;
      if (sc === 'other_subcounty') {
        otherSubCountyDiv.style.display = 'block';
        otherSubCountyInput.setAttribute('required', 'required');
        return;
      }
      const wards = GARISSA_WARDS[sc] || [];
      wards.forEach(w => wardSelect.add(new Option(w, w)));
      wardSelect.add(new Option('Other (Specify below)', 'other_ward'));
      wardSelect.disabled = false;
    }
    
    subCountySelect.addEventListener('change', populateWards);
    wardSelect.addEventListener('change', () => {
      if (wardSelect.value === 'other_ward') {
        otherWardDiv.style.display = 'block';
        otherWardInput.setAttribute('required', 'required');
      } else {
        otherWardDiv.style.display = 'none';
        otherWardInput.removeAttribute('required');
      }
    });
    populateWards();

    // Check for duplicate registration
    function checkDuplicate(email, idNumber) {
      const users = JSON.parse(localStorage.getItem('mbms_users') || '[]');
      return users.some(u => 
        u.email?.toLowerCase() === email.toLowerCase() || 
        u.nemisId === idNumber || 
        u.idNumber === idNumber
      );
    }

    document.getElementById('applicantRegistrationForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.target;
      
      if (!form.checkValidity()) {
        e.stopPropagation();
        form.classList.add('was-validated');
        return;
      }

      const pwd = document.getElementById('password').value;
      const cpwd = document.getElementById('confirmPassword').value;
      if (pwd !== cpwd) {
        document.getElementById('passwordMatchFeedback').style.display = 'block';
        document.getElementById('confirmPassword').classList.add('is-invalid');
        return;
      }

      const email = document.getElementById('emailAddress').value.trim();
      const idNumber = document.getElementById('nemisId').value.trim();

      // Check for duplicates
      if (checkDuplicate(email, idNumber)) {
        alert('⚠️ Applicant already registered!\n\nThis email or ID number is already in use. If you have an account, please login instead.');
        return;
      }

      const payload = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        otherName: document.getElementById('otherName').value.trim(),
        email: email,
        phoneNumber: document.getElementById('phoneNumber').value.trim(),
        gender: document.getElementById('gender').value,
        dateOfBirth: dateOfBirthInput.value,
        yearOfBirth: parseInt(yearOfBirthInput.value),
        idType: idTypeSelect.value,
        nemisId: idNumber,
        idNumber: idNumber, // For compatibility
        subCounty: subCountySelect.value === 'other_subcounty' ? otherSubCountyInput.value.trim() : subCountySelect.value,
        ward: wardSelect.value === 'other_ward' ? otherWardInput.value.trim() : wardSelect.value,
        village: document.getElementById('village').value.trim(),
        role: 'applicant',
        password: pwd, // In production, hash this
        createdAt: new Date().toISOString()
      };

      // Save to localStorage (replace with Firebase Auth later)
      const users = JSON.parse(localStorage.getItem('mbms_users') || '[]');
      users.push(payload);
      localStorage.setItem('mbms_users', JSON.stringify(users));

      alert('✅ Registration successful! Redirecting to login...');
      window.location.href = 'index.html';
    });
  </script>
</body>
</html>
