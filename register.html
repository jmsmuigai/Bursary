<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Register for Garissa County Bursary Application" />
  <title>Garissa MBMS ‚Ä¢ Register</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-app">
  <div class="container py-4 py-md-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card border-0 shadow-lg rounded-4">
          <div class="card-body p-4 p-md-5">
            <div class="text-center mb-4">
              <img src="Garissa Logo.png" alt="" class="logo-circle mb-2" onerror="this.style.display='none'"/>
              <h3 class="text-primary-700 fw-bold mb-1">Applicant Account Registration</h3>
              <div class="text-muted small">Create an account to apply for the county bursary</div>
            </div>

            <div class="alert alert-warning border-0 mb-4">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Note:</strong> If you don't have a National ID, you can use your Birth Certificate Entry Number instead.
            </div>

            <form id="applicantRegistrationForm" class="row g-3 needs-validation" novalidate>
              <h5 class="col-12 mt-2 text-primary-700"><i class="bi bi-person me-2"></i>Personal & Contact Information</h5>
              
              <div class="col-md-4">
                <label class="form-label">Surname <span class="text-danger">*</span></label>
                <input id="lastName" class="form-control" placeholder="e.g. Mukoma" required />
                <div class="invalid-feedback">Surname is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">First Name <span class="text-danger">*</span></label>
                <input id="firstName" class="form-control" placeholder="e.g. James" required />
                <div class="invalid-feedback">First name is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Other Name(s)</label>
                <input id="otherName" class="form-control" placeholder="e.g. Muigai" />
              </div>

              <div class="col-md-6">
                <label class="form-label">Email Address <span class="text-danger">*</span></label>
                <input id="emailAddress" type="email" class="form-control" placeholder="e.g. yourname@example.com" required />
                <div class="invalid-feedback">Valid email is required.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                <input id="phoneNumber" type="tel" class="form-control" placeholder="e.g. 0712345678" required />
                <div class="invalid-feedback">Phone number is required.</div>
              </div>

              <div class="col-md-4">
                <label class="form-label">Gender <span class="text-danger">*</span></label>
                <select id="gender" class="form-select" required>
                  <option value="">-- Select Gender --</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
                <div class="invalid-feedback">Gender is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                <input id="dateOfBirth" type="date" class="form-control" required />
                <div class="invalid-feedback">Date of birth is required.</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Year of Birth <span class="text-danger">*</span></label>
                <input id="yearOfBirth" type="number" class="form-control" min="1980" max="2010" placeholder="e.g. 2000" required />
                <div class="invalid-feedback">Year of birth is required.</div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Identification Type <span class="text-danger">*</span></label>
                <select id="idType" class="form-select" required>
                  <option value="">-- Select Type --</option>
                  <option value="National ID">National ID Number</option>
                  <option value="Birth Certificate">Birth Certificate Entry Number</option>
                </select>
                <div class="invalid-feedback">Identification type is required.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label" id="idLabel">National ID Number <span class="text-danger">*</span></label>
                <input id="nemisId" class="form-control" placeholder="e.g. 12345678" required />
                <div class="invalid-feedback">ID number is required.</div>
              </div>

              <h5 class="col-12 mt-3 text-primary-700"><i class="bi bi-geo-alt me-2"></i>Home Location (Garissa County)</h5>
              
              <div class="col-md-6">
                <label class="form-label">Home Sub-County <span class="text-danger">*</span></label>
                <select id="subCounty" class="form-select" required></select>
                <div class="invalid-feedback">Sub-county is required.</div>
              </div>
              <div class="col-md-6" id="otherSubCountyDiv" style="display:none;">
                <label class="form-label">Specify Sub-County <span class="text-danger">*</span></label>
                <input id="otherSubCounty" class="form-control" placeholder="Enter missing Sub-County" />
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Home Ward <span class="text-danger">*</span></label>
                <select id="ward" class="form-select" required>
                  <option value="">-- Select Sub-County First --</option>
                </select>
                <div class="invalid-feedback">Ward is required. Please select a sub-county first.</div>
              </div>
              <div class="col-md-6" id="otherWardDiv" style="display:none;">
                <label class="form-label">Specify Ward <span class="text-danger">*</span></label>
                <input id="otherWard" class="form-control" placeholder="Enter missing Ward" />
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Village/Bulla/Estate</label>
                <input id="village" class="form-control" placeholder="e.g. Bulla Iftin" />
              </div>

              <h5 class="col-12 mt-3 text-primary-700"><i class="bi bi-shield-lock me-2"></i>Security Credentials</h5>
              
              <div class="col-md-6">
                <label class="form-label">Password <span class="text-danger">*</span></label>
                <input id="password" type="password" class="form-control" minlength="8" required />
                <div class="form-text">Minimum 8 characters, include numbers and symbols</div>
                <div class="invalid-feedback">Password must be at least 8 characters.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Confirm Password <span class="text-danger">*</span></label>
                <input id="confirmPassword" type="password" class="form-control" required />
                <div class="invalid-feedback" id="passwordMatchFeedback">Passwords do not match.</div>
              </div>
              
              <div class="col-12 mt-2">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="robotCheck" required />
                  <label class="form-check-label" for="robotCheck">I'm not a robot (CAPTCHA)</label>
                  <div class="invalid-feedback">Please confirm you're not a robot.</div>
                </div>
              </div>
              
              <div class="col-12 mt-3">
                <div class="d-grid gap-2">
                  <button class="btn btn-primary-700 w-100 py-2" type="submit" id="registerSubmitBtn" style="font-weight: 600; font-size: 1.1rem;">
                    <i class="bi bi-person-plus me-2"></i>Register Account
                  </button>
                </div>
              </div>
              
              <div class="col-12 text-center">
                <a href="index.html" class="link-primary-700 text-decoration-none small">Already have an account? Login ‚Üí</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Mobile Compatibility Layer (load early) -->
  <script src="js/mobile-compat.js"></script>
  <script src="js/data.js"></script>
  <script src="js/auth.js"></script>
  <!-- Registration Form Enhancer (activates all buttons, inputs, dropdowns, adds Save functionality) -->
  <script src="js/registration-enhancer.js"></script>
  <!-- SYSTEM POLISH COMPLETE (activates all dropdowns, buttons, inputs) -->
  <script src="js/system-polish-complete.js"></script>
  <!-- DATABASE CLEAR COMPLETE (for clearing database) -->
  <script src="js/database-clear-complete.js"></script>
  <!-- SYSTEM TEST COMPLETE (comprehensive testing) -->
  <script src="js/system-test-complete.js"></script>
  <!-- SMART ENHANCEMENTS (activates all failing elements, adds smart features) -->
  <script src="js/smart-enhancements.js"></script>
  <!-- UPDATE NOTIFICATION (notifies users of new updates) -->
  <script src="js/update-notification.js"></script>
  
  <!-- Footer -->
  <footer class="mt-5 py-4" style="background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%); color: white;">
    <div class="container">
      <div class="text-center">
        <p class="mb-2" style="font-size: 0.9rem;">
          <span style="color: #FFD700; font-weight: bold;">Garissa County Bursary Management System v3.0</span>
        </p>
        <p class="mb-0" style="font-size: 0.85rem; opacity: 0.9;">
          System developed by <a href="mailto:jmsmuigai@gmail.com" style="color: #FFD700; text-decoration: none; font-weight: bold;">jmsmuigai@gmail.com</a>
        </p>
        <p class="mt-2 mb-0" style="font-size: 0.75rem; opacity: 0.8;">
          ¬© 2025 Garissa County Government. All rights reserved.
        </p>
      </div>
    </div>
  </footer>
  <script>
    const subCountySelect = document.getElementById('subCounty');
    const wardSelect = document.getElementById('ward');
    const otherSubCountyDiv = document.getElementById('otherSubCountyDiv');
    const otherWardDiv = document.getElementById('otherWardDiv');
    const otherSubCountyInput = document.getElementById('otherSubCounty');
    const otherWardInput = document.getElementById('otherWard');
    const idTypeSelect = document.getElementById('idType');
    const idLabel = document.getElementById('idLabel');
    const nemisIdInput = document.getElementById('nemisId');
    const dateOfBirthInput = document.getElementById('dateOfBirth');
    const yearOfBirthInput = document.getElementById('yearOfBirth');

    // Update ID label based on selection
    idTypeSelect.addEventListener('change', function() {
      if (this.value === 'Birth Certificate') {
        idLabel.textContent = 'Birth Certificate Entry Number *';
        nemisIdInput.placeholder = 'e.g. 0121514529';
      } else {
        idLabel.textContent = 'National ID Number *';
        nemisIdInput.placeholder = 'e.g. 12345678';
      }
    });

    // Sync date of birth with year of birth
    dateOfBirthInput.addEventListener('change', function() {
      if (this.value) {
        const year = new Date(this.value).getFullYear();
        yearOfBirthInput.value = year;
      }
    });

    yearOfBirthInput.addEventListener('change', function() {
      if (this.value) {
        const date = new Date(this.value, 0, 1);
        dateOfBirthInput.value = date.toISOString().split('T')[0];
      }
    });

    // Populate subcounties
    subCountySelect.innerHTML = '<option value="">-- Select Sub-County --</option>';
    Object.keys(GARISSA_WARDS).forEach(sc => {
      const opt = new Option(sc, sc);
      subCountySelect.add(opt);
    });
    subCountySelect.add(new Option('Other (Specify below)', 'other_subcounty'));

    function populateWards() {
      wardSelect.innerHTML = '<option value="">-- Select Ward --</option>';
      wardSelect.disabled = true;
      otherSubCountyDiv.style.display = 'none';
      otherWardDiv.style.display = 'none';
      otherSubCountyInput.removeAttribute('required');
      otherWardInput.removeAttribute('required');

      const sc = subCountySelect.value;
      if (sc === 'other_subcounty') {
        otherSubCountyDiv.style.display = 'block';
        otherSubCountyInput.setAttribute('required', 'required');
        return;
      }
      
      if (sc && sc !== '') {
        const wards = GARISSA_WARDS[sc] || [];
        wards.forEach(w => wardSelect.add(new Option(w, w)));
        wardSelect.add(new Option('Other (Specify below)', 'other_ward'));
        wardSelect.disabled = false;
        wardSelect.style.pointerEvents = 'auto';
        wardSelect.style.opacity = '1';
        console.log('‚úÖ Wards populated for', sc, '-', wards.length, 'wards');
      }
    }
    
    subCountySelect.addEventListener('change', populateWards);
    wardSelect.addEventListener('change', () => {
      if (wardSelect.value === 'other_ward') {
        otherWardDiv.style.display = 'block';
        otherWardInput.setAttribute('required', 'required');
      } else {
        otherWardDiv.style.display = 'none';
        otherWardInput.removeAttribute('required');
      }
    });
    populateWards();

    // Check for duplicate registration - checks both users and applications
    function checkDuplicate(email, idNumber, birthCertificate, dateOfBirth) {
      // Check users
      const users = JSON.parse(localStorage.getItem('mbms_users') || '[]');
      const userDuplicate = users.some(u => 
        u.email?.toLowerCase() === email.toLowerCase() || 
        u.nemisId === idNumber || 
        u.idNumber === idNumber
      );
      
      if (userDuplicate) return true;
      
      // Check applications for duplicate ID number or birth certificate
      const applications = JSON.parse(localStorage.getItem('mbms_applications') || '[]');
      const appDuplicate = applications.some(app => {
        const appIdNum = app.idNumber || app.nemisId || app.personalDetails?.idNumber || app.personalDetails?.nemisId || '';
        const appBirthCert = app.birthCertificate || app.personalDetails?.birthCertificate || '';
        const appDob = app.dateOfBirth || app.personalDetails?.dateOfBirth || '';
        
        return (idNumber && appIdNum && appIdNum.toLowerCase() === idNumber.toLowerCase()) ||
               (birthCertificate && appBirthCert && appBirthCert.toLowerCase() === birthCertificate.toLowerCase()) ||
               (dateOfBirth && appDob && appDob === dateOfBirth);
      });
      
      return appDuplicate;
    }

    // Enhanced form submission with better error handling
    document.getElementById('applicantRegistrationForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const form = e.target;
      const submitBtn = document.getElementById('registerSubmitBtn');
      
      // Disable submit button during processing
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
      }
      
      // Validate form
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        
        // Scroll to first invalid field
        const firstInvalid = form.querySelector(':invalid');
        if (firstInvalid) {
          firstInvalid.focus();
          firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // Re-enable submit button
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-person-plus me-2"></i>Register Account';
        }
        return;
      }

      const pwd = document.getElementById('password').value;
      const cpwd = document.getElementById('confirmPassword').value;
      if (pwd !== cpwd) {
        document.getElementById('passwordMatchFeedback').style.display = 'block';
        document.getElementById('confirmPassword').classList.add('is-invalid');
        
        // Re-enable submit button
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-person-plus me-2"></i>Register Account';
        }
        return;
      }

      const email = document.getElementById('emailAddress').value.trim();
      const idNumber = document.getElementById('nemisId').value.trim();
      const birthCertificate = ''; // Add if field exists
      const dateOfBirth = dateOfBirthInput.value;

      // Check for duplicates (ID number, birth certificate, or date of birth)
      if (checkDuplicate(email, idNumber, birthCertificate, dateOfBirth)) {
        alert('‚ö†Ô∏è DUPLICATE ENTRY DETECTED!\n\nThis email, ID number, or birth certificate is already registered in the system.\n\nPlease contact the Fund Administrator at fundadmin@garissa.go.ke for more details.\n\nIf you believe this is an error, please contact support immediately.');
        return;
      }

      const payload = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        otherName: document.getElementById('otherName').value.trim(),
        email: email,
        phoneNumber: document.getElementById('phoneNumber').value.trim(),
        gender: document.getElementById('gender').value,
        dateOfBirth: dateOfBirthInput.value,
        yearOfBirth: parseInt(yearOfBirthInput.value),
        idType: idTypeSelect.value,
        nemisId: idNumber,
        idNumber: idNumber, // For compatibility
        subCounty: subCountySelect.value === 'other_subcounty' ? otherSubCountyInput.value.trim() : subCountySelect.value,
        ward: wardSelect.value === 'other_ward' ? otherWardInput.value.trim() : wardSelect.value,
        village: document.getElementById('village').value.trim(),
        role: 'applicant',
        password: pwd, // In production, hash this
        createdAt: new Date().toISOString()
      };

      // Save to UNIFIED DATABASE (SAME DATABASE as admin portal and applications)
      try {
        // Use unified database access layer - check both saveUser and window.saveUser
        const saveFn = typeof saveUser !== 'undefined' ? saveUser : 
                       (typeof window.saveUser !== 'undefined' ? window.saveUser : null);
        
        if (saveFn) {
          // Use unified database access layer
          const saved = saveFn(payload);
          if (saved) {
            console.log('‚úÖ User registered and saved to UNIFIED DATABASE:', payload.email);
          } else {
            throw new Error('Failed to save user');
          }
        } else {
          // Fallback to direct localStorage access
          const users = JSON.parse(localStorage.getItem('mbms_users') || '[]');
          users.push(payload);
          localStorage.setItem('mbms_users', JSON.stringify(users));
          console.log('‚úÖ User registered and saved (fallback):', payload.email);
        }
      } catch (error) {
        console.error('Registration error:', error);
        alert('Error saving registration. Please try again.\n\nError: ' + error.message);
        
        // Re-enable submit button on error
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-person-plus me-2"></i>Register Account';
        }
        return;
      }
      
      console.log('‚úÖ User registered successfully:', payload.email);

      // Clear saved progress
      localStorage.removeItem('mbms_registration_progress');
      
      // Auto-login after successful registration
      sessionStorage.setItem('mbms_current_user', JSON.stringify(payload));
      
      // CRITICAL: Trigger event to notify admin dashboard of new registration
      window.dispatchEvent(new CustomEvent('mbms-data-updated', {
        detail: { 
          key: 'mbms_users', 
          action: 'registered', 
          email: payload.email,
          user: payload
        }
      }));
      
      // Also trigger storage event for cross-tab sync
      try {
        const currentUsers = JSON.parse(localStorage.getItem('mbms_users') || '[]');
        localStorage.setItem('mbms_users', JSON.stringify(currentUsers));
      } catch (e) {
        console.log('Storage event trigger:', e);
      }
      
      // Show modern success message
      if (submitBtn) {
        submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Registration Successful!';
        submitBtn.classList.remove('btn-primary-700');
        submitBtn.classList.add('btn-success');
      }
      
      // Show success modal with enhanced confirmation
      const successModal = document.createElement('div');
      successModal.className = 'modal fade';
      successModal.id = 'registrationSuccessModal';
      successModal.setAttribute('tabindex', '-1');
      successModal.innerHTML = `
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center p-5">
              <div class="mb-4">
                <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
              </div>
              <h3 class="text-success mb-3">‚úÖ Registration Successful!</h3>
              <div class="alert alert-success text-start mb-4">
                <h6 class="mb-3"><i class="bi bi-info-circle me-2"></i>Your Registration Details:</h6>
                <p class="mb-2"><strong>Email:</strong> ${payload.email}</p>
                <p class="mb-2"><strong>Name:</strong> ${payload.firstName} ${payload.lastName}</p>
                <p class="mb-2"><strong>Location:</strong> ${payload.subCounty} / ${payload.ward}</p>
                <p class="mb-0"><strong>Status:</strong> <span class="badge bg-info">Registered</span></p>
              </div>
              <div class="alert alert-primary text-start mb-4">
                <h6 class="mb-2"><i class="bi bi-check2-circle me-2"></i>What's Next?</h6>
                <p class="mb-1">‚úÖ Your registration has been saved successfully</p>
                <p class="mb-1">‚úÖ You are now logged in automatically</p>
                <p class="mb-0">‚úÖ You can now proceed to submit your bursary application</p>
              </div>
              <div class="alert alert-warning text-start mb-4">
                <small><i class="bi bi-exclamation-triangle me-1"></i><strong>Important:</strong> Your registration details will appear in the Application Management system. You can now start your application.</small>
              </div>
              <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary-700 btn-lg" onclick="window.location.href='applicant_dashboard.html'">
                  <i class="bi bi-arrow-right me-2"></i>Go to Dashboard & Start Application
                </button>
                <a href="index.html" class="btn btn-success btn-lg sign-in-btn" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3); color: white; text-decoration: none;">
                  <i class="bi bi-box-arrow-in-right me-2"></i>SIGN IN NOW
                </a>
              </div>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(successModal);
      
      // Show modal
      if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        const bsModal = new bootstrap.Modal(successModal);
        bsModal.show();
        
        // Auto-redirect after 5 seconds
        setTimeout(() => {
          window.location.href = 'applicant_dashboard.html';
        }, 5000);
      } else {
        // Fallback alert
        alert('‚úÖ Registration successful!\n\nüìß Email: ' + payload.email + '\nüë§ Name: ' + payload.firstName + ' ' + payload.lastName + '\nüìç Location: ' + payload.subCounty + ' / ' + payload.ward + '\n\n‚úÖ Your registration has been saved and will appear in the Application Management system.\n\nYou have been automatically logged in. Redirecting to your dashboard...');
        setTimeout(() => {
          window.location.href = 'applicant_dashboard.html';
        }, 2000);
      }
    });
  </script>
</body>
</html>
