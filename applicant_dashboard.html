<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Track your Garissa County Bursary Application" />
  <title>Garissa MBMS • Applicant Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="bg-app">
  <nav class="navbar navbar-expand-lg navbar-dark" style="background:var(--primary-700);">
    <div class="container">
      <a class="navbar-brand" href="#">
        <img src="Garissa Logo.png" alt="" class="logo-circle me-2" style="width:40px;height:40px;" onerror="this.style.display='none'"/>
        Garissa MBMS
      </a>
      <div class="ms-auto">
        <a href="help.html" class="btn btn-outline-light btn-sm me-2" target="_blank">
          <i class="bi bi-question-circle me-1"></i>Help
        </a>
        <span class="text-white me-3" id="userName">Applicant</span>
        <a href="index.html" class="btn btn-outline-light btn-sm">
          <i class="bi bi-box-arrow-right me-1"></i>Logout
        </a>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="row mb-4">
      <div class="col-md-12">
        <h3 class="text-primary-700 fw-bold">My Application Dashboard</h3>
        <p class="text-muted">Track your bursary application status</p>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="bi bi-file-earmark-text fs-1 text-primary-700 me-3"></i>
              <div>
                <h5 class="mb-0" id="appStatus">No Application</h5>
                <small class="text-muted">Application Status</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="bi bi-calendar-check fs-1 text-info me-3"></i>
              <div>
                <h5 class="mb-0" id="appDate">-</h5>
                <small class="text-muted">Date Submitted</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card border-0 shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="bi bi-cash-coin fs-1 text-success me-3"></i>
              <div>
                <h5 class="mb-0" id="appAmount">-</h5>
                <small class="text-muted">Amount Requested</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4" id="awardedCard" style="display:none;">
        <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #28a745 !important;">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="bi bi-trophy fs-1 text-success me-3"></i>
              <div>
                <h5 class="mb-0 text-success" id="awardedAmount">-</h5>
                <small class="text-muted">Amount Awarded</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-lg">
      <div class="card-header bg-light">
        <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>My Application</h5>
      </div>
      <div class="card-body">
        <div id="applicationContent">
          <div class="text-center py-5">
            <i class="bi bi-file-earmark-plus fs-1 text-muted mb-3"></i>
            <h5>No Application Found</h5>
            <p class="text-muted">You haven't submitted an application yet.</p>
            <a href="application.html" class="btn btn-primary-700">
              <i class="bi bi-plus-circle me-2"></i>Start New Application
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="card border-0 shadow-sm mt-4" id="draftCard" style="display:none;">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="bi bi-file-earmark-dash me-2"></i>Incomplete Application (Draft)</h5>
      </div>
      <div class="card-body">
        <p>You have an incomplete application. You can continue filling it now.</p>
        <a href="application.html" class="btn btn-warning">
          <i class="bi bi-pencil me-2"></i>Continue Application
        </a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="js/data.js"></script>
  <script src="js/budget.js"></script>
  <script src="js/email-notifications.js"></script>
  <script src="js/pdf-generator.js"></script>
  <script>
    // Get current user
    const userStr = sessionStorage.getItem('mbms_current_user');
    if (!userStr) {
      alert('Please login to access your dashboard.');
      window.location.href = 'index.html';
    }

    const user = JSON.parse(userStr);
    document.getElementById('userName').textContent = `${user.firstName} ${user.lastName}`;

    // Load user's application
    const applications = JSON.parse(localStorage.getItem('mbms_applications') || '[]');
    const userApp = applications.find(app => app.applicantEmail === user.email);

    // Check for draft
    const draftKey = `mbms_application_${user.email}`;
    const draft = localStorage.getItem(draftKey);
    if (draft) {
      document.getElementById('draftCard').style.display = 'block';
    }

    if (userApp) {
      // Display application details
      document.getElementById('appStatus').textContent = userApp.status;
      document.getElementById('appDate').textContent = new Date(userApp.dateSubmitted).toLocaleDateString();
      document.getElementById('appAmount').textContent = `Ksh ${userApp.financialDetails.amountRequested.toLocaleString()}`;

      // Show awarded amount if application is awarded
      if (userApp.status === 'Awarded' && userApp.awardDetails) {
        const awardedAmount = userApp.awardDetails.committee_amount_kes || userApp.awardDetails.amount || 0;
        document.getElementById('awardedCard').style.display = 'block';
        document.getElementById('awardedAmount').textContent = `Ksh ${awardedAmount.toLocaleString()}`;
      }

      const serialNumber = userApp.awardDetails?.serialNumber || '';
      const awardedAmount = userApp.status === 'Awarded' && userApp.awardDetails 
        ? (userApp.awardDetails.committee_amount_kes || userApp.awardDetails.amount || 0) 
        : null;

      const content = document.getElementById('applicationContent');
      content.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-primary-700">Application ID</h6>
            <p>${userApp.appID}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary-700">Status</h6>
            <span class="badge bg-${getStatusColor(userApp.status)}">${userApp.status}</span>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary-700">Institution</h6>
            <p>${userApp.personalDetails.institution}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary-700">Registration Number</h6>
            <p>${userApp.personalDetails.regNumber}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary-700">Fee Balance</h6>
            <p>Ksh ${userApp.financialDetails.feeBalance.toLocaleString()}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary-700">Amount Requested</h6>
            <p>Ksh ${userApp.financialDetails.amountRequested.toLocaleString()}</p>
          </div>
          ${awardedAmount ? `
          <div class="col-md-6">
            <h6 class="text-success"><i class="bi bi-trophy me-1"></i>Amount Awarded</h6>
            <p class="text-success fw-bold fs-5">Ksh ${awardedAmount.toLocaleString()}</p>
          </div>
          ` : ''}
          ${serialNumber ? `
          <div class="col-md-6">
            <h6 class="text-primary-700">Award Serial Number</h6>
            <p><strong>${serialNumber}</strong></p>
          </div>
          ` : ''}
        </div>
        <hr>
        <div class="text-center">
          <button class="btn btn-info me-2" onclick="viewMyApplication('${userApp.appID}')" style="min-width: 180px;">
            <i class="bi bi-eye me-2"></i>View Details
          </button>
          <button class="btn btn-success" onclick="downloadMyApplicationLetter('${userApp.appID}')" style="min-width: 180px;">
            <i class="bi bi-download me-2"></i>Download ${userApp.status === 'Awarded' ? 'Award' : userApp.status === 'Rejected' ? 'Rejection' : 'Status'} Letter
          </button>
        </div>
      `;
    } else {
      // Show start application button
      const content = document.getElementById('applicationContent');
      content.innerHTML = `
        <div class="text-center py-5">
          <i class="bi bi-file-earmark-plus fs-1 text-muted mb-3"></i>
          <h5>No Application Found</h5>
          <p class="text-muted">You haven't submitted an application yet.</p>
          <a href="application.html" class="btn btn-primary-700">
            <i class="bi bi-plus-circle me-2"></i>Start New Application
          </a>
        </div>
      `;
    }

    function getStatusColor(status) {
      const colors = {
        'Pending Submission': 'warning',
        'Pending Ward Review': 'info',
        'Pending Committee Review': 'primary',
        'Awarded': 'success',
        'Rejected': 'danger'
      };
      return colors[status] || 'secondary';
    }

    // View application details
    window.viewMyApplication = function(appID) {
      const applications = JSON.parse(localStorage.getItem('mbms_applications') || '[]');
      const app = applications.find(a => a.appID === appID);
      
      if (!app) {
        alert('Application not found.');
        return;
      }

      // Show application details in an alert or modal
      let details = `Application ID: ${app.appID}\n`;
      details += `Status: ${app.status}\n`;
      details += `Institution: ${app.personalDetails?.institution || 'N/A'}\n`;
      details += `Amount Requested: Ksh ${(app.financialDetails?.amountRequested || 0).toLocaleString()}\n`;
      
      if (app.status === 'Awarded' && app.awardDetails) {
        details += `Amount Awarded: Ksh ${(app.awardDetails.committee_amount_kes || app.awardDetails.amount || 0).toLocaleString()}\n`;
        details += `Serial Number: ${app.awardDetails.serialNumber || 'N/A'}\n`;
      }
      
      if (app.status === 'Rejected' && app.rejectionReason) {
        details += `\nReason: ${app.rejectionReason}\n`;
      }
      
      alert(details);
    };

    // Download application letter (works for all statuses)
    window.downloadMyApplicationLetter = async function(appID) {
      const applications = JSON.parse(localStorage.getItem('mbms_applications') || '[]');
      const app = applications.find(a => a.appID === appID);
      
      if (!app) {
        alert('Application not found.');
        return;
      }

      try {
        if (app.status === 'Awarded') {
          if (!app.awardDetails) {
            alert('Award details not available. Please contact the administrator.');
            return;
          }
          await downloadPDFDirect(app, app.awardDetails);
        } else if (app.status === 'Rejected') {
          if (typeof downloadRejectionLetter !== 'undefined') {
            await downloadRejectionLetter(app);
          } else {
            alert('Rejection letter function not available. Please refresh the page.');
          }
        } else {
          if (typeof downloadStatusLetter !== 'undefined') {
            await downloadStatusLetter(app);
          } else {
            alert('Status letter function not available. Please refresh the page.');
          }
        }
      } catch (error) {
        console.error('Error downloading PDF:', error);
        alert('Error downloading letter: ' + error.message);
      }
    };
  </script>
  
  <!-- Footer -->
  <footer class="mt-5 py-4" style="background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%); color: white;">
    <div class="container">
      <div class="text-center">
        <p class="mb-2" style="font-size: 0.9rem;">
          <span style="color: #FFD700; font-weight: bold;">Garissa County Bursary Management System v3.0</span>
        </p>
        <p class="mb-0" style="font-size: 0.85rem; opacity: 0.9;">
          System developed by <a href="mailto:jmsmuigai@gmail.com" style="color: #FFD700; text-decoration: none; font-weight: bold;">jmsmuigai@gmail.com</a>
        </p>
        <p class="mt-2 mb-0" style="font-size: 0.75rem; opacity: 0.8;">
          © 2025 Garissa County Government. All rights reserved.
        </p>
      </div>
    </div>
  </footer>
</body>
</html>

